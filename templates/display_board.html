<!DOCTYPE html>
<html lang="ja" data-bs-theme="{{ current_theme or 'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="{{ refresh_interval }}">
    <title>表示専用ボード: {{ current_area.name }} - WardBoard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        [data-bs-theme="light"] body { background-color: #f0f2f5; }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; }
        .area-title { font-size: 2.5rem; font-weight: bold; margin-bottom: 1.5rem; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-header { border-bottom: 1px solid rgba(0,0,0,0.1); padding: 1rem; }
        .room-name { font-size: 1.5rem; font-weight: bold; }
        .bed-container { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .bed-item { 
            width: 100px; height: 100px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 10px; color: white;
        }
        .bed-name { font-size: 1rem; font-weight: bold; }
        .status-label { font-size: 0.85rem; }
        .room-state-btn { font-size: 1.8rem; font-weight: bold; padding: 1.5rem; border-radius: 10px; width: 100%; color: white; border: none; }
        .last-update { font-size: 0.9rem; color: #6c757d; text-align: right; }

        /* Compact mode */
        {% if config.DISPLAY_COMPACT %}
        .area-title { font-size: 1.8rem; }
        .room-name { font-size: 1.1rem; }
        .bed-item { width: 75px; height: 75px; }
        .bed-name { font-size: 0.8rem; }
        .status-label { font-size: 0.7rem; }
        .bi { font-size: 1.5rem !important; }
        .room-state-btn { font-size: 1.2rem; padding: 0.75rem; }
        {% endif %}
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="area-title mb-0">{{ current_area.name }}</h1>
            <div class="last-update">
                最終更新: {{ now.strftime('%H:%M:%S') }}
            </div>
        </div>

        {% set hidden_count = 0 %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
            {% for data in rooms_data %}
            
            {# 空室非表示ロジック #}
            {% set is_empty = false %}
            {% if config.DISPLAY_HIDE_EMPTY_ROOMS %}
                {% if data.beds %}
                    {% set is_empty = true %}
                    {% for bed_item in data.beds %}
                        {% if bed_item.state and bed_item.state.status.key not in config.VACANT_STATUS_KEYS %}
                            {% set is_empty = false %}
                        {% endif %}
                    {% endfor %}
                {% elif data.room_state %}
                    {% if data.room_state.status.key in config.VACANT_STATUS_KEYS %}
                        {% set is_empty = true %}
                    {% endif %}
                {% endif %}
            {% endif %}

            {% if is_empty %}
                {% set hidden_count = hidden_count + 1 %}
            {% else %}
            <div class="col">
                <div class="card h-100">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="room-name text-truncate">{{ data.room.code }} {{ data.room.name }}</div>
                            {% if config.DISPLAY_SHOW_UPDATED_AT %}
                                {% set last_upd = None %}
                                {% if data.beds %}
                                    {% for bi in data.beds %}
                                        {% if bi.state and (not last_upd or bi.state.updated_at > last_upd) %}
                                            {% set last_upd = bi.state.updated_at %}
                                        {% endif %}
                                    {% endfor %}
                                {% elif data.room_state %}
                                    {% set last_upd = data.room_state.updated_at %}
                                {% endif %}
                                {% if last_upd %}
                                <small class="text-muted" style="font-size: 0.7rem;">{{ last_upd.strftime('%H:%M') }}</small>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        {% if data.beds %}
                            <div class="bed-container">
                                {% for bed_item in data.beds %}
                                {% set bed = bed_item.obj %}
                                {% set state = bed_item.state %}
                                <div class="bed-item {% if state %}{{ state.status.color_class }}{% else %}bg-secondary{% endif %}">
                                    <span class="bed-name">{{ bed.name }}</span>
                                    <i class="bi {% if state %}{{ state.status.icon_class }}{% else %}bi-question-circle{% endif %} fs-3"></i>
                                    <span class="status-label">{% if state %}{{ state.status.label }}{% else %}未設定{% endif %}</span>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            {% set state = data.room_state %}
                            <div class="room-state-btn d-flex justify-content-between align-items-center {% if state %}{{ state.status.color_class }}{% else %}bg-secondary{% endif %}">
                                <span>{% if state %}{{ state.status.label }}{% else %}未設定{% endif %}</span>
                                <i class="bi {% if state %}{{ state.status.icon_class }}{% else %}bi-question-circle{% endif %} fs-1"></i>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        {% if hidden_count > 0 %}
        <div class="mt-3 text-muted small italic">
            <i class="bi bi-info-circle me-1"></i>空き状態の部屋を {{ hidden_count }} 件非表示にしています。
        </div>
        {% endif %}
    </div>
</body>
</html>
