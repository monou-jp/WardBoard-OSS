{% extends "base.html" %}
{% block title %}変更履歴 - 管理画面{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>変更履歴</h2>
    <a href="/admin" class="btn btn-outline-secondary">戻る</a>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="/admin/logs" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">エリア</label>
                <select name="area_id" class="form-select">
                    <option value="">全て</option>
                    {% for area in areas %}
                    <option value="{{ area.id }}" {% if selected_area == area.id|string %}selected{% endif %}>{{ area.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">対象種別</label>
                <select name="target_type" class="form-select">
                    <option value="">全て</option>
                    <option value="room">部屋</option>
                    <option value="bed">ベッド</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">変更者</label>
                <select name="user_id" class="form-select">
                    <option value="">全て</option>
                    {% for u in users %}
                    <option value="{{ u.id }}" {% if selected_user == u.id|string %}selected{% endif %}>{{ u.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">フィルター</button>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>日時</th>
                <th>エリア</th>
                <th>対象</th>
                <th>変更内容</th>
                <th>変更者</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.changed_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ log.area.name if log.area else '-' }}</td>
                <td>
                    {% if log.target_type == 'room' %}
                        <span class="badge bg-info text-dark">部屋</span> {{ log.room.name if log.room else 'Unknown' }}
                    {% else %}
                        <span class="badge bg-secondary">ベッド</span> {{ log.bed.name if log.bed else 'Unknown' }} ({{ log.bed.room.name if (log.bed and log.bed.room) else '-' }})
                    {% endif %}
                </td>
                <td>
                    <span class="text-muted">{{ log.from_status.label if log.from_status else '(初回)' }}</span>
                    <i class="bi bi-arrow-right mx-1"></i>
                    <span class="fw-bold">{{ log.to_status.label if log.to_status else '-' }}</span>
                </td>
                <td>{{ log.changed_by.username if log.changed_by else 'System' }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="text-center">履歴がありません。</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-5 p-4 border rounded bg-light">
    <h4>ログの管理</h4>
    <p class="text-muted">
        現在、<code>LOG_RETENTION_DAYS = {{ config.LOG_RETENTION_DAYS }}</code> に設定されています。
        {% if config.LOG_RETENTION_DAYS > 0 %}
        {{ config.LOG_RETENTION_DAYS }}日より古いログを削除できます。
        {% else %}
        無制限に保持する設定（0）のため、手動削除は行えません。
        {% endif %}
    </p>
    {% if config.LOG_RETENTION_DAYS > 0 %}
    <form action="/admin/logs/purge" method="POST" onsubmit="return confirm('本当に{{ config.LOG_RETENTION_DAYS }}日より古いログを削除しますか？');">
        <button type="submit" class="btn btn-danger">古いログを削除する</button>
    </form>
    {% endif %}
</div>
{% endblock %}
